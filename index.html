<!DOCTYPE html>
<head>
  <title>Pusher Test</title>
  <!-- <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/hmac-sha256.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/enc-base64.min.js"></script>

 
</head>
<body>
  <canvas id="c"></canvas>
  <script>
    let appKey ="bea3cf75e9f8f18cc70a";
    let secretKey ="6e94b23f65859b39498d";
    let socket = new WebSocket("wss://ws-eu.pusher.com/app/"+appKey+"?client=js&version=2.1&protocol=7 HTTP/1.1");
    
    var c = document.getElementById("c");
    var ctx = c.getContext("2d");
    c.width = window.innerWidth
    c.height = window.innerHeight
    var cw = c.width ;
    var ch = c.height ;
    var   cx = cw ,
    cy = ch ;
    var rad = Math.PI / 180;
    var w =cw,
    h = ch;
    //ctx.strokeStyle = "Cornsilk";
    // ctx.lineWidth = 4;
    var ADC=[];
    var Adc;
    var index=0;
    
    window.addEventListener("resize", function() {
      c.width = window.innerWidth
      c.height = window.innerHeight
      cw = c.width;
      ch = c.height;
      cx = cw ,
      cy = ch ;
      w = cw;
      h = ch;
      });
    socket.onopen = function(e) {
      console.log("[open] Connection established");
    
    };
    var ADCString="";
    var ADCArray=[];
    socket.onmessage = function(event) {
      // console.log(`[message] Data received from server: ${event.data}`);
      // console.log(JSON.parse(JSON.parse(event.data).data).socket_id)
      if(JSON.parse(event.data).event=="pusher:connection_established"){
      var hash = CryptoJS.HmacSHA256( JSON.parse(JSON.parse(event.data).data).socket_id+":private-ECGfed", secretKey);
      var hashInHex = CryptoJS.enc.Hex.stringify(hash);
      // console.log(hashInHex);
      socket.send("{\"event\": \"pusher:subscribe\", \"data\": {\"channel\": \"private-ECGfed\" ,\"auth\": \""+appKey+":"+hashInHex+"\"} }")
    }else{
      ADCString=JSON.parse(JSON.parse(event.data).data).x;
      ADCArray = ADCString.split(" ");
      ADCArray[ADCArray.length-1]!=""?null:ADCArray.splice(ADCArray.length-1);
      for (let index = 0; index < ADCArray.length; index++) {
        ADCArray[index]=parseInt(ADCArray[index]);
      }
      console.log(ADCArray)
    }
    };
    var ADCArrayDraw=[];
    var arrayIndex=0;
    setInterval(() => {
    arrayIndex>=ADCArray.length?arrayIndex=0:arrayIndex++;
    index>=(c.width/speed)?index=0:index++;


    ADCArrayDraw[index]=ADCArray[arrayIndex]
    
    }, 1);
    
    socket.onclose = function(event) {
      if (event.wasClean) {
        alert(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
      } else {
        // e.g. server process killed or network down
        // event.code is usually 1006 in this case
        alert('[close] Connection died');
      }
    };
    
    socket.onerror = function(error) {
      alert(`[error]`);
    };
    
    // console.log( performance.now() )
    // var hash = CryptoJS.HmacSHA256("Message", "secret");
    //   var hashInBase64 = CryptoJS.enc.Base64.stringify(hash);
    //   document.write(hashInBase64);
    
    var speed=1;
    function Draw() {
      
      ctx.clearRect(0, 0, cw, ch);
      ctx.beginPath();
       for (var x = 0; x < ADCArrayDraw.length; x+=speed) {
         if ((x/speed)==index+1) {
           ctx.moveTo(x,ch-((ch/4095)*ADCArrayDraw[x/speed]));
        }else{
           ctx.lineTo(x,ch-((ch/4095)*ADCArrayDraw[x/speed])); 
       }
     }
     ctx.stroke();
     // //  console.log(ADC[index]);
     
       requestId = window.requestAnimationFrame(Draw);
     }
     requestId = window.requestAnimationFrame(Draw);  
     
    
      </script>
</body>